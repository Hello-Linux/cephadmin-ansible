---
# tasks file for cepdadm.prepare

- name: Change hostname to match Ansible inventory
  hostname:
    name: "{{ inventory_hostname }}"

- name: Install required packages
  package:
    name:
      - python39
      - lvm2
      - tar
      - chrony
    state: present
  when:
    - CEPH_INSTALL_MODE == "online"

- name: Temporarily disables selinux for command
  shell: "setenforce 0"
  failed_when: false

- name: Close Linux SELinux service
  lineinfile:
    dest: /etc/selinux/config
    regexp: "^SELINUX="
    line: "SELINUX=disabled"

- name: Stop firewalld service
  service:
    name: firewalld
    state: stopped

- name: Config chrony client
  template:
    src: redhat_chrony_client.conf.j2
    dest: /etc/chrony.conf
  when: 'inventory_hostname != groups.chrony[0]'

- name: Start and enable chrony service
  systemd:
    name: chronyd
    state: restarted
    enabled: yes

- name: Wait for chronyd service to start
  shell: "systemctl is-active chronyd.service"
  register: svc_status
  until: '"active" in svc_status.stdout'
  retries: 3
  delay: 10

- name: Add ceph static DNS record
  lineinfile:
    path: /etc/hosts
    line: "{{ hostvars[item]['ansible_default_ipv4']['address'] }} {{ item }}"
    create: yes
  loop: "{{ groups['ceph_cluster'] }}"

- name: Download cephadm
  copy:
    src: "redhat{{ '8' if ansible_facts['distribution_version'] is version('8.0', operator='ge', strict=True) else '7' }}_{{ CEPH_RELEASE }}_cephadm"
    dest: /usr/bin/cephadm
    mode: 'u+x'
    remote_src: false
  when:
    - ansible_facts['distribution_version'] is version('7.0', operator='lt', strict=True) or ansible_facts['distribution_version'] is version('8.0', operator='ge', strict=True)

- name: Init ceph client environment
  block:
    - name: add ceph-common repo
      shell: cephadm add-repo --release {{ CEPH_RELEASE }}
      args:
        warn: no

    - name: install ceph-common package
      shell: cephadm install ceph-common
      args:
        warn: no

    - name: Ensure local tmp directory exists
      file:
        path: "/etc/ceph"
        state: directory
        mode: '0755'
      delegate_to: localhost

    - name: Fetch ceph authentication file to ansible control
      fetch:
        src: "{{ item.src }}"
        dest: "{{ item.dest }"
        flat: yes
      loop:
        - { src: '/etc/ceph/ceph.conf', dest: '/etc/ceph/ceph.conf', mode: '0644' }
        - { src: '/etc/ceph/ceph.client.{{ RBD_USER_NAME }}.keyring', dest: '/etc/ceph/ceph.client.{{ RBD_USER_NAME }}.keyring', mode: '0600' }

    - name: Ensure /etc/ceph directory exists
      file:
        path: /etc/ceph
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Synchronize the authentication file to the ceph client
      copy:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        owner: root
        group: root
        mode: "{{ item.mode }}"
      loop:
        - { src: '/etc/ceph/ceph.conf', dest: '/etc/ceph/ceph.conf', mode: '0644' }
        - { src: '/etc/ceph/ceph.client.{{ RBD_USER_NAME }}.keyring', dest: '/etc/ceph/ceph.client.{{ RBD_USER_NAME }}.keyring', mode: '0600' }
